<div class="entry">

        <script src="http://www.imooc.com/open/courselistrandjs"></script><style type="text/css">.imooc ,.imooc ul,.imooc li{margin:0;padding:0;}.imooc{background:#f0f0f0;text-align:left;}.imooc ul{list-style:none;padding:9px;border:1px dotted #9b9b9b;overflow:hidden;}.imooc ul li{width:300px;float:left;font-size:14px;font-weight:bold;line-height:19px;}.imooc li a{display:block;height:19px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#09c;text-decoration: none;margin-right:10px;}.imooc li a:hover{color:#b30000;}.imooc li.no-data{line-height: 50px;color: #000;}</style><div class="imooc"><ul><li><a target="_blank" title="开启新纪元-进击Node.js（一）" href="http://www.imooc.com/view/348?from=jobboleblog">开启新纪元-进击Node.js（一）</a></li><li><a target="_blank" title="Sass基础入门" href="http://www.imooc.com/view/311?from=jobboleblog">Sass基础入门</a></li><li><a target="_blank" title="Cocos2d-x游戏开发初体验-C++篇" href="http://www.imooc.com/view/400?from=jobboleblog">Cocos2d-x游戏开发初体验-C++篇</a></li><li><a target="_blank" title="Go语言第一课" href="http://www.imooc.com/view/345?from=jobboleblog">Go语言第一课</a></li></ul></div><span style="display:block;margin-bottom:10px;"></span>
		<div class="copyright-area">本文由 <a href="http://blog.jobbole.com">伯乐在线</a> - <a href="http://www.jobbole.com/members/a1ickgu0">Alick</a> 翻译，<a href="http://www.jobbole.com/members/huanglimin">黄利民</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target="_blank" href="http://dak1n1.com/blog/12-nginx-performance-tuning">dak1n1.com</a>。欢迎加入<a target="_blank" href="http://group.jobbole.com/category/feedback/trans-team/">翻译小组</a>。</div><p>这篇文章是《<a href="http://dak1n1.com/blog/13-load-balancing-lvs">打造3百万次请求/秒的高性能服务器集群</a>》系列的第2部分，在这个部分中你可以使用任何一种 WEB 服务器，不过我决定使用 Nginx，因其轻量级、高可靠及高性能的优点。</p>
<p>通常来说，一个优化良好的 Nginx Linux 服务器可以达到 500,000 – 600,000 次/秒 的请求处理性能，然而我的 Nginx 服务器可以稳定地达到 904,000 次/秒 的处理性能，并且我以此高负载测试超过 12 小时，服务器工作稳定。</p>
<p>这里需要特别说明的是，本文中所有列出来的配置都是在我的测试环境验证的，而你需要根据你服务器的情况进行配置：</p>
<p>从 <a href="http://dak1n1.com/blog/12-nginx-performance-tuning/blog/3-getting-more-from-yum-with-rpmforge-and-epel-repos">EPEL</a> 源安装 Nginx：</p>
<div><div id="highlighter_960115" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">yum -y </code><code class="bash functions">install</code> <code class="bash plain">nginx</code></div></div></td></tr></tbody></table></div></div>
<p>备份配置文件，然后根据你的需要进行配置：</p>
<div><div id="highlighter_965847" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash functions">cp</code> <code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf </code><code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf.orig</code></div><div class="line number2 index1 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">vim </code><code class="bash plain">/etc/nginx/nginx</code><code class="bash plain">.conf</code></div></div></td></tr></tbody></table></div></div>
<div><div id="highlighter_279485" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div><div class="line number24 index23 alt1">24</div><div class="line number25 index24 alt2">25</div><div class="line number26 index25 alt1">26</div><div class="line number27 index26 alt2">27</div><div class="line number28 index27 alt1">28</div><div class="line number29 index28 alt2">29</div><div class="line number30 index29 alt1">30</div><div class="line number31 index30 alt2">31</div><div class="line number32 index31 alt1">32</div><div class="line number33 index32 alt2">33</div><div class="line number34 index33 alt1">34</div><div class="line number35 index34 alt2">35</div><div class="line number36 index35 alt1">36</div><div class="line number37 index36 alt2">37</div><div class="line number38 index37 alt1">38</div><div class="line number39 index38 alt2">39</div><div class="line number40 index39 alt1">40</div><div class="line number41 index40 alt2">41</div><div class="line number42 index41 alt1">42</div><div class="line number43 index42 alt2">43</div><div class="line number44 index43 alt1">44</div><div class="line number45 index44 alt2">45</div><div class="line number46 index45 alt1">46</div><div class="line number47 index46 alt2">47</div><div class="line number48 index47 alt1">48</div><div class="line number49 index48 alt2">49</div><div class="line number50 index49 alt1">50</div><div class="line number51 index50 alt2">51</div><div class="line number52 index51 alt1">52</div><div class="line number53 index52 alt2">53</div><div class="line number54 index53 alt1">54</div><div class="line number55 index54 alt2">55</div><div class="line number56 index55 alt1">56</div><div class="line number57 index56 alt2">57</div><div class="line number58 index57 alt1">58</div><div class="line number59 index58 alt2">59</div><div class="line number60 index59 alt1">60</div><div class="line number61 index60 alt2">61</div><div class="line number62 index61 alt1">62</div><div class="line number63 index62 alt2">63</div><div class="line number64 index63 alt1">64</div><div class="line number65 index64 alt2">65</div><div class="line number66 index65 alt1">66</div><div class="line number67 index66 alt2">67</div><div class="line number68 index67 alt1">68</div><div class="line number69 index68 alt2">69</div><div class="line number70 index69 alt1">70</div><div class="line number71 index70 alt2">71</div><div class="line number72 index71 alt1">72</div><div class="line number73 index72 alt2">73</div><div class="line number74 index73 alt1">74</div><div class="line number75 index74 alt2">75</div><div class="line number76 index75 alt1">76</div><div class="line number77 index76 alt2">77</div><div class="line number78 index77 alt1">78</div><div class="line number79 index78 alt2">79</div><div class="line number80 index79 alt1">80</div><div class="line number81 index80 alt2">81</div><div class="line number82 index81 alt1">82</div><div class="line number83 index82 alt2">83</div><div class="line number84 index83 alt1">84</div><div class="line number85 index84 alt2">85</div><div class="line number86 index85 alt1">86</div><div class="line number87 index86 alt2">87</div><div class="line number88 index87 alt1">88</div><div class="line number89 index88 alt2">89</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash comments"># This number should be, at maximum, the number of CPU cores on your system.</code></div><div class="line number2 index1 alt1"><code class="bash comments"># (since nginx doesn't benefit from more than one worker per CPU.)</code></div><div class="line number3 index2 alt2"><code class="bash comments"># 这里的数值不能超过 CPU 的总核数，因为在单个核上部署超过 1 个 Nginx 服务进程并不起到提高性能的作用。</code></div><div class="line number4 index3 alt1"><code class="bash plain">worker_processes 24;</code></div><div class="line number5 index4 alt2">&nbsp;</div><div class="line number6 index5 alt1"><code class="bash comments"># Number of file descriptors used for Nginx. This is set in the OS with 'ulimit -n 200000'</code></div><div class="line number7 index6 alt2"><code class="bash comments"># or using /etc/security/limits.conf</code></div><div class="line number8 index7 alt1"><code class="bash comments"># Nginx 最大可用文件描述符数量，同时需要配置操作系统的 "ulimit -n 200000"，或者在 /etc/security/limits.conf 中配置。 </code></div><div class="line number9 index8 alt2"><code class="bash plain">worker_rlimit_nofile 200000;</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="bash comments"># only log critical errors</code></div><div class="line number12 index11 alt1"><code class="bash comments"># 只记录 critical 级别的错误日志</code></div><div class="line number13 index12 alt2"><code class="bash plain">error_log </code><code class="bash plain">/var/log/nginx/error</code><code class="bash plain">.log crit</code></div><div class="line number14 index13 alt1">&nbsp;</div><div class="line number15 index14 alt2"><code class="bash comments"># Determines how many clients will be served by each worker process.</code></div><div class="line number16 index15 alt1"><code class="bash comments"># (Max clients = worker_connections * worker_processes)</code></div><div class="line number17 index16 alt2"><code class="bash comments"># "Max clients" is also limited by the number of socket connections available on the system (~64k)</code></div><div class="line number18 index17 alt1"><code class="bash comments"># 配置单个 Nginx 单个进程可服务的客户端数量，（最大值客户端数 = 单进程连接数 * 进程数 ）</code></div><div class="line number19 index18 alt2"><code class="bash comments"># 最大客户端数同时也受操作系统 socket 连接数的影响（最大 64K ）</code></div><div class="line number20 index19 alt1"><code class="bash plain">worker_connections 4000;</code></div><div class="line number21 index20 alt2">&nbsp;</div><div class="line number22 index21 alt1"><code class="bash comments"># essential for linux, optmized to serve many clients with each thread</code></div><div class="line number23 index22 alt2"><code class="bash comments"># Linux 关键配置，允许单个线程处理多个客户端请求。</code></div><div class="line number24 index23 alt1"><code class="bash plain">use epoll;</code></div><div class="line number25 index24 alt2">&nbsp;</div><div class="line number26 index25 alt1"><code class="bash comments"># Accept as many connections as possible, after nginx gets notification about a new connection.</code></div><div class="line number27 index26 alt2"><code class="bash comments"># May flood worker_connections, if that option is set too low.</code></div><div class="line number28 index27 alt1"><code class="bash comments"># 允许尽可能地处理更多的连接数，如果 worker_connections 配置太低，会产生大量的无效连接请求。</code></div><div class="line number29 index28 alt2"><code class="bash plain">multi_accept on;</code></div><div class="line number30 index29 alt1">&nbsp;</div><div class="line number31 index30 alt2"><code class="bash comments"># Caches information about open FDs, freqently accessed files.</code></div><div class="line number32 index31 alt1"><code class="bash comments"># Changing this setting, in my environment, brought performance up from 560k req/sec, to 904k req/sec.</code></div><div class="line number33 index32 alt2"><code class="bash comments"># I recommend using some varient of these options, though not the specific values listed below.</code></div><div class="line number34 index33 alt1"><code class="bash comments"># 缓存高频操作文件的FDs（文件描述符/文件句柄）</code></div><div class="line number35 index34 alt2"><code class="bash comments"># 在我的设备环境中，通过修改以下配置，性能从 560k 请求/秒 提升到 904k 请求/秒。</code></div><div class="line number36 index35 alt1"><code class="bash comments"># 我建议你对以下配置尝试不同的组合，而不是直接使用这几个数据。</code></div><div class="line number37 index36 alt2"><code class="bash plain">open_file_cache max=200000 inactive=20s;</code></div><div class="line number38 index37 alt1"><code class="bash plain">open_file_cache_valid 30s;</code></div><div class="line number39 index38 alt2"><code class="bash plain">open_file_cache_min_uses 2;</code></div><div class="line number40 index39 alt1"><code class="bash plain">open_file_cache_errors on;</code></div><div class="line number41 index40 alt2">&nbsp;</div><div class="line number42 index41 alt1"><code class="bash comments"># Buffer log writes to speed up IO, or disable them altogether</code></div><div class="line number43 index42 alt2"><code class="bash comments"># 将日志写入高速 IO 存储设备，或者直接关闭日志。</code></div><div class="line number44 index43 alt1"><code class="bash comments"># access_log /var/log/nginx/access.log main buffer=16k;</code></div><div class="line number45 index44 alt2"><code class="bash plain">access_log off;</code></div><div class="line number46 index45 alt1">&nbsp;</div><div class="line number47 index46 alt2"><code class="bash comments"># Sendfile copies data between one FD and other from within the kernel.</code></div><div class="line number48 index47 alt1"><code class="bash comments"># More efficient than read() + write(), since the requires transferring data to and from the user space.</code></div><div class="line number49 index48 alt2"><code class="bash comments"># 开启 sendfile 选项，使用内核的 FD 文件传输功能，这个比在用户态用 read() + write() 的方式更加高效。</code></div><div class="line number50 index49 alt1"><code class="bash plain">sendfile on;</code></div><div class="line number51 index50 alt2">&nbsp;</div><div class="line number52 index51 alt1"><code class="bash comments"># Tcp_nopush causes nginx to attempt to send its HTTP response head in one packet,</code></div><div class="line number53 index52 alt2"><code class="bash comments"># instead of using partial frames. This is useful for prepending headers before calling sendfile,</code></div><div class="line number54 index53 alt1"><code class="bash comments"># or for throughput optimization.</code></div><div class="line number55 index54 alt2"><code class="bash comments"># 打开 tcp_nopush 选项，Nginux 允许将 HTTP 应答首部与数据内容在同一个报文中发出。</code></div><div class="line number56 index55 alt1"><code class="bash comments"># 这个选项使服务器在 sendfile 时可以提前准备 HTTP 首部，能够达到优化吞吐的效果。</code></div><div class="line number57 index56 alt2"><code class="bash plain">tcp_nopush on;</code></div><div class="line number58 index57 alt1">&nbsp;</div><div class="line number59 index58 alt2"><code class="bash comments"># don't buffer data-sends (disable Nagle algorithm). Good for sending frequent small bursts of data in real time.</code></div><div class="line number60 index59 alt1"><code class="bash comments"># 不要缓存 data-sends （关闭 Nagle 算法），这个能够提高高频发送小数据报文的实时性。</code></div><div class="line number61 index60 alt2"><code class="bash plain">tcp_nodelay on;</code></div><div class="line number62 index61 alt1">&nbsp;</div><div class="line number63 index62 alt2"><code class="bash comments"># Timeout for keep-alive connections. Server will close connections after this time.</code></div><div class="line number64 index63 alt1"><code class="bash comments"># 配置连接 keep-alive 超时时间，服务器将在超时之后关闭相应的连接。</code></div><div class="line number65 index64 alt2"><code class="bash plain">keepalive_timeout 30;</code></div><div class="line number66 index65 alt1">&nbsp;</div><div class="line number67 index66 alt2"><code class="bash comments"># Number of requests a client can make over the keep-alive connection. This is set high for testing.</code></div><div class="line number68 index67 alt1"><code class="bash comments"># 单个客户端在 keep-alive 连接上可以发送的请求数量，在测试环境中，需要配置个比较大的值。</code></div><div class="line number69 index68 alt2"><code class="bash plain">keepalive_requests 100000;</code></div><div class="line number70 index69 alt1">&nbsp;</div><div class="line number71 index70 alt2"><code class="bash comments"># allow the server to close the connection after a client stops responding. Frees up socket-associated memory.</code></div><div class="line number72 index71 alt1"><code class="bash comments"># 允许服务器在客户端停止发送应答之后关闭连接，以便释放连接相应的 socket 内存开销。</code></div><div class="line number73 index72 alt2"><code class="bash plain">reset_timedout_connection on;</code></div><div class="line number74 index73 alt1">&nbsp;</div><div class="line number75 index74 alt2"><code class="bash comments"># send the client a "request timed out" if the body is not loaded by this time. Default 60.</code></div><div class="line number76 index75 alt1"><code class="bash comments"># 配置客户端数据请求超时时间，默认是 60 秒。</code></div><div class="line number77 index76 alt2"><code class="bash plain">client_body_timeout 10;</code></div><div class="line number78 index77 alt1">&nbsp;</div><div class="line number79 index78 alt2"><code class="bash comments"># If the client stops reading data, free up the stale client connection after this much time. Default 60.</code></div><div class="line number80 index79 alt1"><code class="bash comments"># 客户端数据读超时配置，客户端停止读取数据，超时时间后断开相应连接，默认是 60 秒。</code></div><div class="line number81 index80 alt2"><code class="bash plain">send_timeout 2;</code></div><div class="line number82 index81 alt1">&nbsp;</div><div class="line number83 index82 alt2"><code class="bash comments"># Compression. Reduces the amount of data that needs to be transferred over the network</code></div><div class="line number84 index83 alt1"><code class="bash comments"># 压缩参数配置，减少在网络上所传输的数据量。</code></div><div class="line number85 index84 alt2"><code class="bash functions">gzip</code> <code class="bash plain">on;</code></div><div class="line number86 index85 alt1"><code class="bash plain">gzip_min_length 10240;</code></div><div class="line number87 index86 alt2"><code class="bash plain">gzip_proxied expired no-cache no-store private auth;</code></div><div class="line number88 index87 alt1"><code class="bash plain">gzip_types text</code><code class="bash plain">/plain</code> <code class="bash plain">text</code><code class="bash plain">/css</code> <code class="bash plain">text</code><code class="bash plain">/xml</code> <code class="bash plain">text</code><code class="bash plain">/javascript</code> <code class="bash plain">application</code><code class="bash plain">/x-javascript</code> <code class="bash plain">application</code><code class="bash plain">/xml</code><code class="bash plain">;</code></div><div class="line number89 index88 alt2"><code class="bash plain">gzip_disable </code><code class="bash string">"MSIE [1-6]."</code><code class="bash plain">;</code></div></div></td></tr></tbody></table></div></div>
<p>启动 Nginx 并配置起机自动加载。</p>
<div><div id="highlighter_289779" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">service nginx start</code></div><div class="line number2 index1 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">chkconfig nginx on</code></div></div></td></tr></tbody></table></div></div>
<p>配置 Tsung 并启动测试，测试差不多 10 分钟左右就能测试到服务器的峰值能力，具体的时间与你的 Tsung 配置相关。</p>
<div><div id="highlighter_529105" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">[root@loadnode1 ~] vim ~/.tsung</code><code class="bash plain">/tsung</code><code class="bash plain">.xml</code></div><div class="line number2 index1 alt1"><code class="bash spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="bash plain">&amp;lt;server host=</code><code class="bash string">"YOURWEBSERVER"</code> <code class="bash plain">port=</code><code class="bash string">"80"</code> <code class="bash functions">type</code><code class="bash plain">=</code><code class="bash string">"tcp"</code><code class="bash plain">/&amp;gt;</code></div></div></td></tr></tbody></table></div></div>
<div><div id="highlighter_725872" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">tsung start</code></div></div></td></tr></tbody></table></div></div>
<p>你觉得测试结果已经够了的情况下，通过 ctrl+c 退出，之后使用我们之前配置的别名命令 treport 查看测试报告。</p>
<h4><span style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;font-size: 16px;font-style: normal;font-weight: bold">WEB 服务器调优，第二部分：TCP 协议栈调优</span></h4>
<p>这个部分不只是对 Ngiinx 适用，还可以在任何 WEB 服务器上使用。通过对内核 TCP 配置的优化可以提高服务器网络带宽。</p>
<p>以下配置在我的 10-Gbase-T 服务器上工作得非常完美，服务器从默认配置下的 8Gbps 带宽提升到 9.3Gbps。</p>
<p>当然，你的服务器上的结论可能不尽相同。</p>
<p>下面的配置项，我建议每次只修订其中一项，之后用网络性能测试工具 netperf、iperf 或是用我类似的测试脚本 <a href="https://github.com/dak1n1/cluster-netbench/blob/master/netbench.pl">cluster-netbench.pl</a> 对服务器进行多次测试。</p>
<div><div id="highlighter_412102" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">yum -y </code><code class="bash functions">install</code> <code class="bash plain">netperf iperf</code></div></div></td></tr></tbody></table></div></div>
<div><div id="highlighter_256607" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">vim </code><code class="bash plain">/etc/sysctl</code><code class="bash plain">.conf</code></div></div></td></tr></tbody></table></div></div>
<div><div id="highlighter_738597" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div><div class="line number2 index1 alt1">2</div><div class="line number3 index2 alt2">3</div><div class="line number4 index3 alt1">4</div><div class="line number5 index4 alt2">5</div><div class="line number6 index5 alt1">6</div><div class="line number7 index6 alt2">7</div><div class="line number8 index7 alt1">8</div><div class="line number9 index8 alt2">9</div><div class="line number10 index9 alt1">10</div><div class="line number11 index10 alt2">11</div><div class="line number12 index11 alt1">12</div><div class="line number13 index12 alt2">13</div><div class="line number14 index13 alt1">14</div><div class="line number15 index14 alt2">15</div><div class="line number16 index15 alt1">16</div><div class="line number17 index16 alt2">17</div><div class="line number18 index17 alt1">18</div><div class="line number19 index18 alt2">19</div><div class="line number20 index19 alt1">20</div><div class="line number21 index20 alt2">21</div><div class="line number22 index21 alt1">22</div><div class="line number23 index22 alt2">23</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash comments"># Increase system IP port limits to allow for more connections</code></div><div class="line number2 index1 alt1"><code class="bash comments"># 调高系统的 IP 以及端口数据限制，从可以接受更多的连接</code></div><div class="line number3 index2 alt2"><code class="bash plain">net.ipv4.ip_local_port_range = 2000 65000</code></div><div class="line number4 index3 alt1">&nbsp;</div><div class="line number5 index4 alt2"><code class="bash plain">net.ipv4.tcp_window_scaling = 1</code></div><div class="line number6 index5 alt1">&nbsp;</div><div class="line number7 index6 alt2"><code class="bash comments"># number of packets to keep in backlog before the kernel starts dropping them</code></div><div class="line number8 index7 alt1"><code class="bash comments"># 设置协议栈可以缓存的报文数阀值，超过阀值的报文将被内核丢弃</code></div><div class="line number9 index8 alt2"><code class="bash plain">net.ipv4.tcp_max_syn_backlog = 3240000</code></div><div class="line number10 index9 alt1">&nbsp;</div><div class="line number11 index10 alt2"><code class="bash comments"># increase socket listen backlog</code></div><div class="line number12 index11 alt1"><code class="bash comments"># 调高 socket 侦听数阀值</code></div><div class="line number13 index12 alt2"><code class="bash plain">net.core.somaxconn = 3240000</code></div><div class="line number14 index13 alt1"><code class="bash plain">net.ipv4.tcp_max_tw_buckets = 1440000</code></div><div class="line number15 index14 alt2">&nbsp;</div><div class="line number16 index15 alt1"><code class="bash comments"># Increase TCP buffer sizes</code></div><div class="line number17 index16 alt2"><code class="bash comments"># 调大 TCP 存储大小</code></div><div class="line number18 index17 alt1"><code class="bash plain">net.core.rmem_default = 8388608</code></div><div class="line number19 index18 alt2"><code class="bash plain">net.core.rmem_max = 16777216</code></div><div class="line number20 index19 alt1"><code class="bash plain">net.core.wmem_max = 16777216</code></div><div class="line number21 index20 alt2"><code class="bash plain">net.ipv4.tcp_rmem = 4096 87380 16777216</code></div><div class="line number22 index21 alt1"><code class="bash plain">net.ipv4.tcp_wmem = 4096 65536 16777216</code></div><div class="line number23 index22 alt2"><code class="bash plain">net.ipv4.tcp_congestion_control = cubic</code></div></div></td></tr></tbody></table></div></div>
<p>每次修订配置之后都需要执行以下命令使之生效.</p>
<div><div id="highlighter_783850" class="syntaxhighlighter notranslate bash"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td class="gutter"><div class="line number1 index0 alt2">1</div></td><td class="code"><div class="container"><div class="line number1 index0 alt2"><code class="bash plain">sysctl -p </code><code class="bash plain">/etc/sysctl</code><code class="bash plain">.conf</code></div></div></td></tr></tbody></table></div></div>
<p>别忘了在配置修订之后务必要进行网络 benchmark 测试，这样可以观测到具体是哪个配置修订的优化效果最明显。通过这种有效测试方法可以为你节省大量时间。</p>
<hr>

        
        
    <div class="post-adds">
        <span data-post-id="87531" class="btn-bluet href-style vote-post-up   register-user-only "><i class="fa  fa-thumbs-o-up"></i> <h10 id="87531votetotal">3</h10> 赞</span>
        <span data-book-type="1" data-site-id="2" data-item-id="87531" data-item-type="1" class="btn-bluet href-style bookmark-btn  register-user-only "><i class="fa fa-bookmark-o  "></i> 1 收藏</span>

                <a href="#article-comment"><span class="btn-bluet href-style"><i class="fa fa-comments-o"></i>  评论</span></a>
        
            </div>


        <!-- BEGIN #author-bio -->

<div id="author-bio">
	
	<h3 class="widget-title">
	关于作者：<a target="_blank" href="http://www.jobbole.com/members/a1ickgu0">Alick</a>
	</h3>
	<div class="alignleft">
		<a target="_blank" href="http://www.jobbole.com/members/a1ickgu0">
			<img src="http://jbcdn2.b0.upaiyun.com/2015/06/b6542d1884eed47149da8f68b90a8fc1-300x300.png">
		</a>
	</div>

    <div class="author-bio-info">

        <span class="author-bio-info-block">
            这个码农很懒，啥也没有留下.        </span>
        <span class="author-bio-info-block">
            <a href="http://www.jobbole.com/members/a1ickgu0" target="_blank"><i class="fa fa-user"></i> 个人主页</a> · 
            <a href="http://blog.jobbole.com/author/a1ickgu0/" target="_blank"><i class="fa fa-file-text-o"></i> 我的文章</a>

             · <a title="声望值" target="_blank" href="http://www.jobbole.com/members/a1ickgu0/reputation/"><i class="fa fa-graduation-cap"></i> 10</a> · <a title="微博主页" target="_blank" href="http://weibo.com/1798547731/"><i class="fa fa-weibo"></i></a>&nbsp;        </span>
    </div>
	<div class="clear"></div>
</div>

<!-- END #author-bio -->
	</div>