
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Mongoose 基本功能使用</title>
	<meta property='og:locale' content='zh_CN'/>
	<meta property='og:title' content='Mongoose 基本功能使用'/>
	<meta property='og:url' content='http://www.yif1.com'/>
	<meta property='og:site_name' content='程序员 - 博客 - HuangDing'/>
	<meta property='og:type' content='article'/>
	<script src="http://libs.baidu.com/jquery/1.5.0/jquery.min.js"></script>
	<link href='/assets/themes/the-program/css/style.css' rel="stylesheet" media="all" />
	<link href='/assets/default.css' rel="stylesheet" media="all" />
	<link href="/assets/highlight/google-code-prettify/prettify.css" rel="stylesheet" type="text/css" media="all">
</head>
<body>

<div id="page" class="hentry">
	<header class="the-header">
		<div class="unit-head">
			<div class="unit-inner unit-head-inner">
				<nav class="nav-global">
					<ul>
						<li class="logo"><a href="/">HuangDing</a></li>
						<li class="code"><a href="/code.html">code</a></li>
						<li class="archive"><a href="/archive.html">archive</a></li>
						<li class="about"><a href="/info.html">about</a></li>
					</ul>
				</nav>
				<nav id="sub-nav" class="alignright">
					<div class="social">
					<a class="rss" href="/atom.xml" title="RSS">RSS</a>
					</div>
					<form class="search" action="http://google.com/search" method="get">
						<input class="" type="text" name="q">
						<input type="hidden" name="q" value="site:http://www.yif1.com">
					</form>
				</nav>
			</div><!-- unit-inner -->
		</div><!-- unit-head -->
	</header>
	<div class="body" role="main">
		<div class="unit-body">
			<div class="unit-inner unit-body-inner">
				<div class="entry-content">
					
<article class="unit-article layout-page">
	<div class="unit-inner unit-article-inner">
		<div class="content">
			<header>
				<div class="unit-head">
					<div class="unit-inner unit-head-inner">
						<h1 class="h2 entry-title">Mongoose 基本功能使用</h1>
					</div><!-- unit-inner -->
				</div><!-- unit-head -->
			</header>

			<div class="bd">
				<div class="entry-content">
					<p>Mongoose 是 MongoDB 数据库的模型工具，为 NodeJS 设计，工作于异步环境下。</p>

<p>与其它同类工具相比，一回更喜欢它灵活友好的 API。相似的，还存在MongoSkin，MongoLian，以及原生驱动 node-mongodb-native等。</p>

<h2>Mongoose 是什么？</h2>

<p>Mongoose 是 MongoDB 数据库的模型工具，为 NodeJS 设计，工作于异步环境下。</p>

<p>与其它同类工具相比，一回更喜欢它灵活友好的 API。相似的，还存在MongoSkin，MongoLian，以及原生驱动 node-mongodb-native等。</p>

<h2>查询文档</h2>

<p>查询多条文档：</p>

<pre><code>Model.find(query, fields, options, callback);
</code></pre>

<p>其中 Model 为 Mongoose 模型对象。</p>

<p>query参数与 MongoDB 查询条件一致。</p>

<p>fields 指定查询的键，一般我们需要哪些键就指定哪些，以节省系统内存消耗，输入[]，则查询所有的键。</p>

<p>options 选项，有 limit, skip, populate 等等。</p>

<p>callback 则是回调函数，查询完毕后执行。该回调函数支持传入两个参数，分别为 err 和 result，如果 err 为非假则说明查询发生了错误，可以 console.log(err) 将错误打印到控制台；如果 result 为假，则说明没有查到符合条件的数据。</p>

<p>查询单条文档参数与 find 是一样的，只不过返回的是一条数据。</p>

<pre><code>Model.findOne(query, fields, options, callback);
</code></pre>

<p>查询单条文档，还有一种最高效的方式，根据文档 ID 查询：</p>

<pre><code>Model.findById(id, fields, options, callback);
</code></pre>

<h2>创建文档</h2>

<p>Mongoose 为模型对象提供了 create 方法用于创建 MongoDB 文档，语法如下：</p>

<pre><code>Model.create(doc, callback);
</code></pre>

<p>通常我们的 doc 都是单条记录，直接插入即可，callback 回调函数有两个参数，分别为 err 和 创建的 doc 记录，但对 update 或 remove 的回调函数来说，第二个参数并不一样，以后会介绍。</p>

<p>doc 也支持批量插入，即传入数组文档，比如做数据导入时，循环插入单条记录与批量插入相比，消耗时间差别还是很大的，因为单条插入每次需要发送请求头给 MongoDB 数据库服务器，这与前端减少请求数提升应用性能的原理是一样的。</p>

<h2>更新文档</h2>

<p>更新文档细节其实挺多的，语法如下：</p>

<pre><code>Model.update(conditions, update, options, callback);
</code></pre>

<p><em>参数解释</em></p>

<p>conditions 即查找条件，与 MongoDB shell 条件一样的。</p>

<p>update 指定要更新的数据，Mongoose 会自动转换为原子级更新。</p>

<p>options 选项，有 safe 和 multi 等，前者可以指定是否采用安全插入，如果不需要安全插入，设置为 {safe: false} 则不需要等待数据库服务器返回结果，响应速度会变快。multi 指定是否更新符合条件的所有文档，默认 false。</p>

<p>callback 回调函数，有俩参数，err 和 num，其中 num 为本次更新影响的记录数，此处与创建文档回调函数第二个参数不同，需要注意。</p>

<p><em>代码样例</em></p>

<pre><code>UserModel.update({}, {
    $set: {favorite_num: 0},
    $inc: {credit: 10},
    $addToSet: {fans: adminId},
    $unset: {articles: 1}

}, {safe: false, multi: true}).run();
</code></pre>

<h2>删除文档</h2>

<p>删除文档与创建文档类似，有俩参数：</p>

<pre><code>Model.remove(conditions, callback);
</code></pre>

<p><em>需要注意的点：</em></p>

<p>删除语句调用后，如果不指定 callback 则返回 Query 对象，这点与更新文档方法 update 以及查询方法 find 是一样的，必须指定 callback 或者调用 run 或 exec 方法才能将指令传递给 MongoDB 数据库。</p>

<p><em>移除数据库中时间超过 3 天的动态：</em></p>

<pre><code>var cond = {date: {$lt: +new Date() - 3*24*60*60*1000}};
FeedModel.remove(cond).run();
</code></pre>

<h2>Mongoose 嵌入文档操作</h2>

<p>使用 Mongoose 过程中首次遇到该问题，查了好久的资料没找到答案，如今碰巧解决了，即记录下来。</p>

<p>嵌入文档分为两种基本形式，分别为：</p>

<pre><code>user: {  // 第一种
    email: String,
    username: String
}
user: [{  // 第二种
    email: String,
    username: String
}]
</code></pre>

<p>注意，这里第二种嵌入文档的形式虽是这样，但实际编码中这样写存在着问题就是不能更新指定条件的数组成员，比如下面的代码会报错：</p>

<pre><code>TestModel.update({'user.email': 'xianlihua@csser.com'}, {$set: {'user.$.username': '一回'}}, {multi: true}).run();

TypeError: Cannot call method 'path' of undefined
</code></pre>

<p>但在 <code>MongoDB Shell</code> 中完全执行正确。</p>

<p>所以正确的写法是先定义子模式，再用 Mongoose 模式嵌套方式定义 <code>user</code> 键：</p>

<pre><code>var SubSchema = {
    email: String,
    username: String
};

// ...
user: [SubSchema]
</code></pre>

<h2>Mongoose 中 group、findAndModify 及 mapReduce 的使用</h2>

<p><code>group</code> 是 MongoDB 中非常类似 MySQL group by 的查询指令。比较遗憾的是在 Mongoose Model 上并不存在该方法，我们需要直接操作 Mongoose 所依赖的 node-mongodb-native。</p>

<pre><code>MessageModel.collection.group(keys, condition, initial, reduce, final, command, callback);
</code></pre>

<p>Model.collection 可以直接取得原生驱动的 Collection 对象，这种方法代价最小。</p>

<p>同样还有一些其它指令可以采用类似的方式，比如：<code>mapreduce</code>，你可以阅读<a href="https://github.com/christkv/node-mongodb-native/blob/master/lib/mongodb/collection.js">node-mongodb-native</a>源码查看详细参数使用方法。</p>

<p>源码文件路径在如下：</p>

<pre><code>node_modules/mongoose/node_modules/mongodb/lib/mongodb/collection.js
</code></pre>

<p>比如，mapReduce 和 findAndModify 如下方式使用：</p>

<pre><code>Model.collection.mapReduce(map, reduce, options, callback);

Model.collection.findAndModify(query, sort, update, options, callback);
</code></pre>

<h2>mongoose 排序的运用</h2>

<p>查询就要用到排序，使用 mongoose 的 Model 直接查询时，排序是作为第三个参数的选项来设置的，比如：</p>

<pre><code>QuestionModel.find(condition, fields, {sort: [['_id', -1]]}, callback);
</code></pre>

<p>注意 <code>sort</code> 的写法，上例将查询结果按时间倒序，因为 MongoDB 的 _id 生成算法中已经包含了当前的时间，所以这样写不仅没问题，也是推荐的按时间排序的写法。</p>

<pre><code>var query = QuestionModel.find(condition, fields);
query.desc('_id');
query.run(function (err, questions) {
    // ....
});
</code></pre>

<p>这也是一种写法，直接用 Query 对象的排序方法进行排序。</p>

<h2>避免对一个键进行多种操作</h2>

<p>这句话的意思是说，如果希望对文档的同一个键进行多种操作，比如现在有一个 tags 键（数组结构），希望既对其 pull 又 希望同时 addToSet 新元素，下面的写法是不对的：</p>

<pre><code>... {$pullAll: {tags: minus}, $addToSet: {tags: {$each: plus}}} ...
</code></pre>

<p>这一点，MongoDB 权威指南上也有提到。</p>

<p>所以为了满足这样的需求，建议事先对新 tags 进行处理得到一个 newTags 数组，通过 \$set 修改器更新这个键。</p>

				</div><!-- entry-content -->
			</div><!-- bd -->
		</div><!-- content -->
	</div><!-- unit-inner -->
</article>


				</div>
			</div><!-- unit-inner -->
		</div><!-- unit-body -->
		<p class="licence">
			Theme: <a href="http://themes.jekyllbootstrap.com/">the_program</a> based on <a href="http://jekyllbootstrap.com/">Jekyll-bootstrap</a>.<br>
			Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a>.<!--<script src="http://s21.cnzz.com/stat.php?id=4827427&web_id=4827427&show=pic" language="JavaScript"></script>-->
		</p>
	</div><!-- body -->
</div><!-- page -->
<!--
<script>
/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
</script>
-->


<script type="text/javascript" src="/assets/highlight/google-code-prettify/prettify.js"></script>
<script src="/assets/modernizr.min.js"></script>
<script src='/assets/default.js'></script>
</body>
</html>

