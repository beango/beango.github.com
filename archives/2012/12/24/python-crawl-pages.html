<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>python爬虫</title>
  <meta name="description" content="module.py">

  <link rel="canonical" href="127.0.0.1/archives/2012/12/24/python-crawl-pages.html">

  <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
  <!-- <link rel="stylesheet" href="/assets/css/icard_resume.css"> -->
  <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
  <link rel="stylesheet" href="/assets/css/blog.css" >
  <link rel="stylesheet" href="/assets/css/syntax.css">
  <!-- <link rel="stylesheet" href="/assets/css/prettify.css" /> --> <!-- 设置代码主题，此文件为默认主题，你可以换成其他主题-->
  <!-- <script src="/assets/css/prettify.js" type="text/javascript"></script> -->
  <link rel="icon" type="image/png" href="/assets/img/avatar.png">

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="assets/js/html5shiv.min.js"></script>
  <script src="assets/js/respond.min.js"></script>
  <![endif]-->

</head>


  <body>

    <header class="bloghead">
    <dev class="authorheader">
        <a href="/">
            <img alt="My Avatar" src="/assets/img/avatar.png"/>
        </a>
        <dev class="blogtitle">
            <h1><a href="/">HuangDing</a></h1>
            <h5> 自己选的路，跪着也走下去! </h5>
        </dev>
    </dev>

    <nav class="menu" role="nav">
        <ul>
            <li><a href="/">Home</a></li>
            <li>|</li>
            <li><a href="/menu.html">Menu</a></li>
            <li>|</li>
            <li><a href="/collection.html">Collection</a></li>
            <li>|</li>
            <li><a target="_blank" href="https://github.com/beango">Github</a></li>
            <li>|</li>
            <li><a target="_blank" href="/about.html">About Me</a></li>
        </ul>
    </nav>
</header>

    <main class="blogmain">
      <h2 id="modulepy">module.py</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env python  </span>
<span class="c">#coding:utf-8  </span>

<span class="kn">from</span> <span class="nn">mongoengine</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">books</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span> 
    <span class="n">bookid</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">()</span>
    <span class="n">bookname</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
    <span class="n">bookurl</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">"bookid"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bookid</span><span class="p">,</span><span class="s">"bookname"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bookname</span><span class="p">,</span><span class="s">"bookurl"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bookurl</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">bookgroup</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span> 
    <span class="n">groupid</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">()</span>
    <span class="n">bookid</span> <span class="o">=</span> <span class="n">ObjectIdField</span><span class="p">()</span>
    <span class="n">groupname</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">"bookid"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bookid</span><span class="p">,</span><span class="s">"groupid"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">groupid</span><span class="p">,</span><span class="s">"groupname"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">groupname</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">booktitle</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="n">titleno</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">()</span>
    <span class="n">bookid</span> <span class="o">=</span> <span class="n">ObjectIdField</span><span class="p">()</span>
    <span class="c">#groupid = ObjectIdField()</span>
    <span class="n">booktitle</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
    <span class="n">titleurl</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">"titleno"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">titleno</span><span class="p">,</span><span class="s">"bookid"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">bookid</span><span class="p">,</span><span class="s">"booktitle"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">booktitle</span><span class="p">,</span><span class="s">"titleurl"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">titleurl</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">charpter</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
    <span class="n">titleno</span> <span class="o">=</span> <span class="n">IntField</span><span class="p">()</span>
    <span class="n">titleid</span> <span class="o">=</span> <span class="n">ObjectIdField</span><span class="p">()</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">tostring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">"titleno"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">titleno</span><span class="p">,</span><span class="s">"titleid"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">titleid</span><span class="p">,</span><span class="s">"content"</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">}</span>
</code></pre>
</div>

<h2 id="crawlpy">crawl.py</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#!/usr/bin/env python  </span>
<span class="c">#coding:utf-8  </span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">ctime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">gridfs</span>
<span class="kn">import</span> <span class="nn">thread</span><span class="o">,</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">urllib</span><span class="o">,</span> <span class="nn">urllib2</span>  
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>  
<span class="kn">from</span> <span class="nn">pymongo</span> <span class="kn">import</span> <span class="n">Connection</span>
<span class="kn">from</span> <span class="nn">module</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>
<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>  
            <span class="s">'input'</span><span class="p">:</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span>   
            <span class="s">'output'</span><span class="p">:</span><span class="s">'./samples'</span><span class="p">,</span>   
            <span class="s">'location'</span><span class="p">:</span><span class="s">'xxx'</span><span class="p">,</span>   
            <span class="s">'has-fn'</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>   
            <span class="s">'options'</span><span class="p">:{</span><span class="s">'connect.timeout'</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span> <span class="s">'timeout'</span><span class="p">:</span><span class="mi">3600</span><span class="p">},</span>   
            <span class="s">'log'</span><span class="p">:</span><span class="nb">file</span><span class="p">(</span><span class="s">'logs.txt'</span><span class="p">,</span> <span class="s">'w'</span><span class="p">),</span>   
        <span class="p">}</span>  

<span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">"http://www.58xs.com/html/75/75623/index.html"</span><span class="p">,</span>
         <span class="s">"http://www.58xs.com/html/180/180531/index.html"</span><span class="p">,</span>
         <span class="s">"http://www.58xs.com/html/177/177945/index.html"</span><span class="p">,</span>
         <span class="s">"http://www.58xs.com/html/195/195623/index.html"</span><span class="p">,</span>
         <span class="s">"http://www.58xs.com/html/187/187344/index.html"</span><span class="p">,</span>
         <span class="s">"http://www.58xs.com/html/196/196689/index.html"</span><span class="p">,</span>
         <span class="s">"http://www.58xs.com/html/117/117423/index.html"</span><span class="p">,</span>
         <span class="p">]</span>  

<span class="k">class</span> <span class="nc">ThreadUrl</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="s">"""Threaded Url Grab"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_url</span><span class="p">,</span> <span class="n">queue_charpter</span><span class="p">,</span> <span class="n">bucket</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_url</span> <span class="o">=</span> <span class="n">queue_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_charpter</span> <span class="o">=</span> <span class="n">queue_charpter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_url</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c">#grabs host from queue</span>
                <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_url</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

                <span class="c">#grabs urls of hosts and then grabs chunk of webpage</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

                <span class="c">#parse the chunk</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span><span class="n">from_encoding</span><span class="o">=</span><span class="s">"utf8"</span><span class="p">)</span><span class="c">#"&lt;head&gt;&lt;title&gt;1vca23&lt;/title&gt;&lt;/head&gt;"  </span>
                <span class="n">bookid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">"(/)"</span><span class="p">,</span><span class="n">host</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">"utf-8"</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"最新章节"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>

                <span class="n">oldbook</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">"bookid"</span><span class="p">:</span><span class="n">bookid</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">oldbook</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">book1</span> <span class="o">=</span> <span class="n">books</span><span class="p">(</span><span class="n">bookid</span><span class="o">=</span><span class="n">bookid</span><span class="p">,</span> <span class="n">bookname</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">bookurl</span><span class="o">=</span><span class="n">host</span><span class="p">)</span>
                    <span class="n">bookid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">book1</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bookid</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">oldbook</span><span class="p">[</span><span class="s">"_id"</span><span class="p">])</span>

                <span class="c">#print time.strftime('%Y-%m-%d %H:%M:%S',time.localtime(time.time()))+": "+str(bookid)</span>
                
                <span class="n">content</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"table"</span><span class="p">,</span><span class="s">"t"</span><span class="p">)</span>
                <span class="n">grouptitle</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"td"</span><span class="p">)</span>  
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">groupid</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grouptitle</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">'class'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">a</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s">"href"</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"http://"</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">queue_charpter</span><span class="o">.</span><span class="n">put</span><span class="p">([</span><span class="n">bookid</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="n">g</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue_url</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                    

<span class="k">class</span> <span class="nc">ThreadCharpter</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="s">"""Threaded Url Grab"""</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_charpter</span><span class="p">,</span> <span class="n">bucket</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_charpter</span> <span class="o">=</span> <span class="n">queue_charpter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span> <span class="o">=</span> <span class="n">bucket</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_charpter</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c">#grabs host from queue</span>
                <span class="n">_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue_charpter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">bookid</span> <span class="o">=</span> <span class="n">_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">_item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">_item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">charpterurl</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'(/)'</span><span class="p">,</span><span class="n">host</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">g</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="s">"href"</span><span class="p">]</span>
                <span class="n">titleno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'(</span><span class="err">\</span><span class="s">.)'</span><span class="p">,</span><span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'(/)'</span><span class="p">,</span><span class="n">charpterurl</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]))[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">oldtitle</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">booktitle</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">"titleno"</span><span class="p">:</span><span class="n">titleno</span><span class="p">,</span><span class="s">"bookid"</span><span class="p">:</span><span class="n">bookid</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">oldtitle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">title1</span> <span class="o">=</span> <span class="n">booktitle</span><span class="p">(</span><span class="n">titleno</span><span class="o">=</span><span class="n">titleno</span><span class="p">,</span> <span class="n">bookid</span><span class="o">=</span><span class="n">bookid</span><span class="p">,</span> <span class="n">booktitle</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">titleurl</span><span class="o">=</span><span class="n">charpterurl</span><span class="p">)</span>
                    <span class="n">titleid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">booktitle</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">title1</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span><span class="c">#title1.save()["id"]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">titleid</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">oldtitle</span><span class="p">[</span><span class="s">"_id"</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">charid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'(</span><span class="err">\</span><span class="s">.)'</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'(/)'</span><span class="p">,</span><span class="n">charpterurl</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:][</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">oldchar</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">charpter</span><span class="o">.</span><span class="n">find_one</span><span class="p">({</span><span class="s">"titleno"</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">charid</span><span class="p">,</span><span class="mi">0</span><span class="p">)})</span>
                    <span class="k">if</span> <span class="n">oldchar</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">url2</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">charpterurl</span><span class="p">)</span>  
                        <span class="n">chunk2</span> <span class="o">=</span> <span class="n">url2</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">soup2</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">chunk2</span><span class="p">)</span>
                        <span class="n">content</span> <span class="o">=</span> <span class="n">soup2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"div"</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="s">"content"</span><span class="p">)</span>
                        
                        <span class="n">obj</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"fieldset"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"table"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"script"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"script"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"div"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

                        <span class="n">obj</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">"div"</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">replaceWith</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>

                        <span class="n">charptercontent</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">"58xs.com"</span><span class="p">,</span><span class="s">""</span><span class="p">)</span>
                        <span class="n">charpter1</span> <span class="o">=</span> <span class="n">charpter</span><span class="p">(</span><span class="n">titleno</span><span class="o">=</span><span class="n">titleno</span><span class="p">,</span><span class="n">titleid</span><span class="o">=</span><span class="n">titleid</span><span class="p">,</span><span class="n">charpterid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">charid</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">content</span><span class="o">=</span><span class="n">charptercontent</span><span class="p">)</span>
                        <span class="n">charid</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">charpter</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">charpter1</span><span class="o">.</span><span class="n">tostring</span><span class="p">())</span>
                        
                        <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">soup2</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s">"img"</span><span class="p">):</span>
                            <span class="n">u</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="s">"src"</span><span class="p">])</span>
                            <span class="n">r</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="n">imgfile</span> <span class="o">=</span> <span class="s">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'(/)'</span><span class="p">,</span><span class="n">img</span><span class="p">[</span><span class="s">"src"</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
                            <span class="n">oid</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">imgfile</span><span class="p">,</span> <span class="n">charpterid</span><span class="o">=</span><span class="n">charid</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">IOError</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">charpterurl</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">charpterurl</span>
                    <span class="k">raise</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">queue_charpter</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="nb">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">(</span><span class="s">"192.168.1.200"</span><span class="p">)</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">book</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">gridfs</span><span class="o">.</span><span class="n">GridFS</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s">'charpter'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">queue_url</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">queue_charpter</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="s">'''
    db.books.drop()
    db.bookgroup.drop()
    db.booktitle.drop()
    db.charpter.drop()
    db.charpter.files.drop()
    db.charpter.chunks.drop()
    '''</span>
    <span class="n">threadsize</span><span class="o">=</span><span class="mi">10</span>

    <span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
        <span class="n">queue_url</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span> 
    
    <span class="k">while</span> <span class="n">threadsize</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">ThreadUrl</span><span class="p">(</span><span class="n">queue_url</span><span class="p">,</span> <span class="n">queue_charpter</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">threadsize</span> <span class="o">-=</span> <span class="mi">1</span>
   
    <span class="n">threadjoin</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
    
    <span class="n">threadsize</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">while</span> <span class="n">threadsize</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">ThreadCharpter</span><span class="p">(</span><span class="n">queue_charpter</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
        <span class="n">ct</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span>
        <span class="n">threadsize</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="n">threadjoin</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">threadjoin</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span><span class="n">threads</span><span class="p">):</span>
    <span class="n">end</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span> 
                <span class="n">end</span> <span class="o">=</span> <span class="bp">False</span><span class="p">;</span> 
                <span class="k">break</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">end</span><span class="p">:</span> 
            <span class="k">break</span><span class="p">;</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">continue</span>
<span class="n">main</span><span class="p">()</span>
<span class="k">print</span> <span class="s">"Elapsed Time: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
</code></pre>
</div>


    </main>

    <div class="footer-copyright">
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="col-md-12">
                Copyright &copy; 2016 黃丁 - All rights reserved.
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="/assets/js/jquery.min.js"></script>
<script type="text/javascript" src="/assets/js/bootstrap.min.js"></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74743250-2', 'auto');
  ga('send', 'pageview');

</script>


  </body>

</html>
