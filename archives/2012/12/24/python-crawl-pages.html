<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="author" content="HuangDing" />
<meta name="keywords" content="python,BeautifulSoup,mongodb" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>程序员 - 博客 - HuangDing / python爬虫</title>
<link href="http://http://uwebs.tk/feed.xml" rel="alternate" title="程序员 - 博客 - HuangDing" type="application/atom+xml" />
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/site.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/code/github.css" />

</head>

<body class="page-type-post">

<div class="main">
	<article>
	
<h2 id="modulepy">module.py</h2>

<pre><code>#!/usr/bin/env python  
#coding:utf-8  

from mongoengine import *

class books(Document): 
    bookid = IntField()
    bookname = StringField()
    bookurl = StringField()
    def tostring(self):
        return {"bookid":self.bookid,"bookname":self.bookname,"bookurl":self.bookurl}

class bookgroup(Document): 
    groupid = IntField()
    bookid = ObjectIdField()
    groupname = StringField()
    def tostring(self):
        return {"bookid":self.bookid,"groupid":self.groupid,"groupname":self.groupname}

class booktitle(Document):
    titleno = IntField()
    bookid = ObjectIdField()
    #groupid = ObjectIdField()
    booktitle = StringField()
    titleurl = StringField()
    def tostring(self):
        return {"titleno":self.titleno,"bookid":self.bookid,"booktitle":self.booktitle,"titleurl":self.titleurl}

class charpter(Document):
    titleno = IntField()
    titleid = ObjectIdField()
    content = StringField()
    def tostring(self):
        return {"titleno":self.titleno,"titleid":self.titleid,"content":self.content}
</code></pre>

<h2 id="crawlpy">crawl.py</h2>

<pre><code>#!/usr/bin/env python  
#coding:utf-8  

import re
import sys
from time import sleep, ctime
import time
import Queue
import gridfs
import thread, threading
import urllib, urllib2  
from bs4 import BeautifulSoup  
from pymongo import Connection
from module import *
from bson import ObjectId
config = {  
            'input':sys.stdin,   
            'output':'./samples',   
            'location':'xxx',   
            'has-fn':False,   
            'options':{'connect.timeout':60, 'timeout':3600},   
            'log':file('logs.txt', 'w'),   
        }  

hosts = ["http://www.58xs.com/html/75/75623/index.html",
         "http://www.58xs.com/html/180/180531/index.html",
         "http://www.58xs.com/html/177/177945/index.html",
         "http://www.58xs.com/html/195/195623/index.html",
         "http://www.58xs.com/html/187/187344/index.html",
         "http://www.58xs.com/html/196/196689/index.html",
         "http://www.58xs.com/html/117/117423/index.html",
         ]  

class ThreadUrl(threading.Thread):
    """Threaded Url Grab"""
    def __init__(self, queue_url, queue_charpter, bucket):
        threading.Thread.__init__(self)
        self.queue_url = queue_url
        self.queue_charpter = queue_charpter
        self.bucket = bucket
    def run(self):
        while not self.queue_url.empty():
            try:
                #grabs host from queue
                host = self.queue_url.get(False)

                #grabs urls of hosts and then grabs chunk of webpage
                url = urllib2.urlopen(host)
                chunk = url.read()

                #parse the chunk
                soup = BeautifulSoup(chunk,from_encoding="utf8")#"&lt;head&gt;&lt;title&gt;1vca23&lt;/title&gt;&lt;/head&gt;"  
                bookid = int(re.split("(/)",host)[-3:-2][0])
                title = soup.h1.string.encode("utf-8").strip().replace("最新章节","")

                oldbook = db.books.find_one({"bookid":bookid})
                if oldbook is None:
                    book1 = books(bookid=bookid, bookname=title, bookurl=host)
                    bookid = db.books.insert(book1.tostring())
                else:
                    bookid = ObjectId(oldbook["_id"])

                #print time.strftime('%Y-%m-%d %H:%M:%S',time.localtime(time.time()))+": "+str(bookid)
                
                content = soup.find("table","t")
                grouptitle = content.find_all("td")  
                i = 0
                j = 1
                groupid=1
                for g in grouptitle:
                    if 'class' not in g.attrs:
                        if not g.a or g.a["href"].find("http://")==0:
                            continue
                        else:
                            self.queue_charpter.put([bookid,host,g])
                self.queue_url.task_done()
            except Exception:
                self.bucket.put(sys.exc_info())
                    

class ThreadCharpter(threading.Thread):
    """Threaded Url Grab"""
    def __init__(self, queue_charpter, bucket):
        threading.Thread.__init__(self)
        self.queue_charpter = queue_charpter
        self.bucket = bucket
    def run(self):
        while not self.queue_charpter.empty():
            try:
                #grabs host from queue
                _item = self.queue_charpter.get(False)
                bookid = _item[0]
                host = _item[1]
                g = _item[2]

                charpterurl = "".join(re.split('(/)',host)[0:-1])+g.a["href"]
                titleno = int("".join(re.split('(\.)',"".join(re.split('(/)',charpterurl)[-1:]))[0:1]),0)
                oldtitle = db.booktitle.find_one({"titleno":titleno,"bookid":bookid})
                if oldtitle is None:
                    title1 = booktitle(titleno=titleno, bookid=bookid, booktitle=g.string.strip(), titleurl=charpterurl)
                    titleid = db.booktitle.insert(title1.tostring())#title1.save()["id"]
                else:
                    titleid = ObjectId(oldtitle["_id"])
                try:
                    charid = re.split('(\.)',re.split('(/)',charpterurl)[-1:][0])[0]
                    oldchar = db.charpter.find_one({"titleno":int(charid,0)})
                    if oldchar is None:
                        url2 = urllib2.urlopen(charpterurl)  
                        chunk2 = url2.read()
                        soup2 = BeautifulSoup(chunk2)
                        content = soup2.find("div",id="content")
                        
                        obj = content.find("fieldset")
                        if obj:
                            obj.replaceWith("")

                        obj = content.find("table")
                        if obj:
                            obj.replaceWith("")

                        obj = content.find("script")
                        if obj:
                            obj.replaceWith("")

                        obj = content.find("script")
                        if obj:
                            obj.replaceWith("")

                        obj = content.find("div")
                        if obj:
                            obj.replaceWith("")

                        obj = content.find("div")
                        if obj:
                            obj.replaceWith("")

                        charptercontent = content.prettify().replace("58xs.com","")
                        charpter1 = charpter(titleno=titleno,titleid=titleid,charpterid=int(charid,0), content=charptercontent)
                        charid = db.charpter.insert(charpter1.tostring())
                        
                        for img in soup2.find_all("img"):
                            u = urllib2.urlopen(img["src"])
                            r = u.read()
                            imgfile = "".join(re.split('(/)',img["src"])[-1:])
                            oid = fs.put(r, filename=imgfile, charpterid=charid)
                except IOError:
                    print charpterurl
                except:
                    print charpterurl
                    raise
                self.queue_charpter.task_done()
            except Queue.Empty:
                pass
            except Exception:
                self.bucket.put(sys.exc_info())
            
start = time.time()

conn = Connection("192.168.1.200")
db = conn.book
fs = gridfs.GridFS(db, collection='charpter')

def main():
    bucket = Queue.Queue()
    queue_url = Queue.Queue()
    queue_charpter = Queue.Queue()
    '''
    db.books.drop()
    db.bookgroup.drop()
    db.booktitle.drop()
    db.charpter.drop()
    db.charpter.files.drop()
    db.charpter.chunks.drop()
    '''
    threadsize=10

    for host in hosts:
        queue_url.put(host)
    threads = [] 
    
    while threadsize&gt;0:
        t = ThreadUrl(queue_url, queue_charpter, bucket)
        t.start()
        threads.append(t)
        threadsize -= 1
   
    threadjoin(bucket,threads)
    
    threadsize = 10
    while threadsize&gt;0:
        ct = ThreadCharpter(queue_charpter, bucket)
        ct.start()
        threads.append(ct)
        threadsize -= 1

    threadjoin(bucket,threads)

def threadjoin(bucket,threads):
    end = True
    while True:
        try:
            exc = bucket.get(block=False)
            raise Exception(exc)
        except Queue.Empty:
            pass
        for t in threads:
            if t.isAlive(): 
                end = False; 
                break;
        if end: 
            break; 
        else:
            end = True
            continue
main()
print "Elapsed Time: %s" % (time.time() - start)
</code></pre>


</article>


	<footer>
		<p>&copy; Since 2012</p>
	</footer>
</div>

<aside>
	<h2><a href="/">程序员 - 博客 - HuangDing</a><a href="/feed.xml" class="feed-link" title="Subscribe"><i class="fa fa-rss-square"></i></a></h2>
	
	<nav class="block">
		<ul>
		<li class="default"><a href="/category/default/">转载</a></li>
		<li class="code"><a href="/category/code/">笔记</a></li>
		
		</ul>
	</nav>
	
	<form action="/search/" class="block block-search">
		<h3>Search</h3>
		<p><input type="search" name="q" placeholder="Search" /></p>
	</form>
	
	<div class="block block-about">
		<h3>About</h3>
		<figure>
			
			<figcaption><strong>HuangDing</strong></figcaption>
		</figure>
		<p>dotnet, mvc, python</p>
	</div>
	
	<div class="block block-license">
		<h3>Copyright</h3>
		<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/cn/" target="_blank" class="hide-target-icon" title="Copyright declaration of site content"><img alt="知识共享许可协议" src="http://i.creativecommons.org/l/by-nc-nd/2.5/cn/88x31.png" /></a></p>
	</div>
	
	
	<div class="block block-fork">
		<a href="https://github.com/beango"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
	</div>
	
	
	<div class="block block-thank">
		<h3>Powered by</h3>
		<p>
			<a href="http://disqus.com/" target="_blank">Disqus</a>,
			<a href="http://elfjs.com/" target="_blank">elf+js</a>,
			<a href="https://github.com/" target="_blank">GitHub</a>,
			<a href="http://www.google.com/cse/" target="_blank">Google Custom Search</a>,
			<a href="http://en.gravatar.com/" target="_blank">Gravatar</a>,
			<a href="http://softwaremaniacs.org/soft/highlight/en/">HighlightJS</a>,
			<a href="https://github.com/mojombo/jekyll" target="_blank">jekyll</a>,
			<a href="https://github.com/mytharcher/SimpleGray" target="_blank">SimpleGray</a>
		</p>
	</div>
</aside>

<script src="http://elfjs.qiniudn.com/code/elf-0.5.0.min.js"></script>
<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

<script src="/assets/js/site.js"></script>

<script>
site.URL_GOOGLE_API = 'http://www.google.com/jsapi';
site.URL_DISCUS_COMMENT = 'beango' ? 'http://beango.disqus.com/embed.js' : '';

site.VAR_SITE_NAME = '程序员 - 博客 - HuangDing';
site.VAR_GOOGLE_CUSTOM_SEARCH_ID = '015845096645085761197:gh2gyye7u1m';
site.TPL_SEARCH_TITLE = '#{0} / 搜索：#{1}';
site.VAR_AUTO_LOAD_ON_SCROLL = 0;
</script>
</body>
</html>