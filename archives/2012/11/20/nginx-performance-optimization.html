<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="author" content="HuangDing" />
<meta name="keywords" content="nginx,linux" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>程序员 - 博客 - HuangDing / nginx性能优化</title>
<link href="http://http://uwebs.tk/feed.xml" rel="alternate" title="程序员 - 博客 - HuangDing" type="application/atom+xml" />
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/site.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/code/github.css" />

</head>

<body class="page-type-post">

<div class="main">
	<div class="trace">/ <a href="/">程序员 - 博客 - HuangDing</a> / nginx性能优化</div>

<article>
	<h1><a href="/archives/2012/11/20/nginx-performance-optimization.html">nginx性能优化</a></h1>
	
	<p class="meta">
	<span class="datetime">2012-11-20</span> posted in [<a href="/category/default" class="category">转载</a>]
</p>
	
<p>作者：<a href="http://www.dbasky.net">Mike.Xu</a> 发表于: December 28, 2009 9:09 PM</p>

<p>[](http://creativecommons.org/licenses/by/2.5/cn/)转载时请务必以超链接形式标明文章<a href="http://www.dbasky.net/archives/2009/12/nginx.html">原始出处</a>和作者信息及<a href="http://www.dbasky.net/archives/2009/12/nginx.html">本版权声明</a>。</p>

<p>链接：<a href="http://www.dbasky.net/archives/2009/12/nginx.html">http://www.dbasky.net/archives/2009/12/nginx.html</a></p>

<p><strong>操作系统</strong>：CentOS 5.3</p>

<p><strong>nginx</strong>的安装就不详细介绍了,请大家移步到我以前写的二篇文章</p>

<p><a href="http://www.dbasky.net/archives/2009/03/nginphp-web.html">Ngin＋php搭建高性能web服务器</a></p>

<p><a href="http://www.dbasky.net/archives/2009/08/nginx-python-django-memcached-mysql-fastcgi.html">搭建nginx + python + django +memcached+ mysql +fastcgi环境</a></p>

<p>1.编译安装</p>

<pre><code>./configure --with-poll_module --with-http_ssl_module
--with-http_gzip_static_module --with-http_perl_module
--with-md5=/usr/include --with-md5-asm --with-sha1=/usr/include
--with-sha1-asm
make
make install
</code></pre>

<p>2.制作SSL证书</p>

<p>生成CA证书</p>

<pre><code>openssl req -days 3650 -nodes -new -x509 -keyout ca.key -out ca.pem -config OpenSSL.cnf
</code></pre>

<p>生成自签名ssl证书</p>

<pre><code>openssl req -days 3650 -nodes -new -keyout cert.key -out cert.pem -config OpenSSL.cnf
</code></pre>

<p>对证书进行签名</p>

<pre><code>openssl ca -days 3650 -out cert.pem -in cert.pem -extensions server -config OpenSSL.cnf
</code></pre>

<p>3.配置优化</p>

<p>修改nginx.conf,工作进程10个，使用epoll事件模型，并发连接使用默认的1024个，启用gzip动态和静态压缩。</p>

<pre><code>worker_processes 10;

events {
  use epoll;
  worker_connections 1024;
}

http {
    gzip  on;
    gzip_static on;
 
    gzip_comp_level     9;
    gzip_min_length     1k;
    gzip_proxied        any;
    gzip_types          text/plain text/xml application/xml application/xml+rss;
    #gzip_disable        "MSIE [1-6] \.";
    #gzip_vary           on;
}
</code></pre>

<p>复制cert.key和cert.pem到conf目录，去掉HTTPS server下面的注释，启用SSL。</p>

<p>4.启用php
下载安装spawn-fcgi，建立/tmp/php-fcgi.sock的连接，并添加nginx配置。</p>

<pre><code>location ~ \.php$ {
    root           html;
    fastcgi_pass   unix:/tmp/php-fcgi.sock;
    fastcgi_index  index.php;
    fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    fastcgi_param  PATH_INFO        $fastcgi_path_info;
    fastcgi_param  PATH_TRANSLATED  $document_root$fastcgi_path_info;
    include        fastcgi_params;
}
</code></pre>

<p>下载安装APC、eAccelerator为php加速。</p>

<p>建立缓存目录</p>

<pre><code>mkdir /var/tmp/eaccelerator
</code></pre>

<p>eAccelerator配置</p>

<pre><code>[eAccelerator]
zend_extension_ts = "/usr/lib/php5/ext/eAccelerator.so"
eaccelerator.shm_size = "16"
eaccelerator.cache_dir = "/var/tmp/eaccelerator"
eaccelerator.enable = "1"
eaccelerator.optimizer = "1"
eaccelerator.check_mtime = "1"
eaccelerator.debug = "0"
eaccelerator.filter = ""
eaccelerator.shm_max = "0"
eaccelerator.shm_ttl = "0"
eaccelerator.shm_prune_period = "0"
eaccelerator.shm_only = "0"
eaccelerator.compress = "1"
eaccelerator.compress_level = "9"
</code></pre>

<p>5.启动nginx</p>

<p>运行命令</p>

<pre><code>sudo spawn-fcgi -f /usr/bin/php-cgi -s /tmp/php-fcgi.sock -F 2 -u nobody
sudo /usr/local/nginx/sbin/nginx
</code></pre>

<p>为了方便管理，使用如下脚本，保存为nginx，放到/etc/init.d目录</p>

<pre><code>#! /bin/sh
#
# nginx daemon script
#

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/usr/local/nginx/sbin/nginx
NAME=nginx
PIDFILE=/usr/local/nginx/logs/$NAME.pid
PHPSOCKET=/tmp/php-fcgi.sock
PHPPIDFILE=/tmp/run/php-fcgi.pid
PHPSPAWN="spawn-fcgi -f /usr/bin/php-cgi -s $PHPSOCKET -P $PHPPIDFILE -F 2 -u nobody"

test -x $DAEMON || exit 0

set -e

case "$1" in
  start)
echo "Starting $NAME."
$DAEMON
$PHPSPAWN
;;

  stop)
echo "Stopping $NAME."
$DAEMON -s stop
kill `cat $PHPPIDFILE`
rm -f $PHPSOCKET $PHPPIDFILE
;;

  restart)
echo "Restarting $NAME."
$DAEMON -s reopen
kill `cat $PHPPIDFILE`
rm -f $PHPSOCKET $PHPPIDFILE
$PHPSPAWN
;;

  reload)
    if [ ! -f $PIDFILE ]; then
      echo "nginx not started."
      exit 1
    fi
    echo "Reloading $NAME."
    $DAEMON -s reload
    ;;

  test)
    $DAEMON -t
    ;;

  *)
N=/etc/init.d/$NAME
echo "Usage: $N start|stop|restart|reload|test" &gt;&amp;2
exit 1
;;
esac

exit 0 
</code></pre>

	
	<!--<p class="permalink">永久链接：<a href="http://http://uwebs.tk/archives/2012/11/20/nginx-performance-optimization.html">http://http://uwebs.tk/archives/2012/11/20/nginx-performance-optimization.html</a></p>-->
</article>
<div id="disqus_thread" class="comments"></div>


	<footer>
		<p>&copy; Since 2012</p>
	</footer>
</div>

<aside>
	<h2><a href="/">程序员 - 博客 - HuangDing</a><a href="/feed.xml" class="feed-link" title="Subscribe"><i class="fa fa-rss-square"></i></a></h2>
	
	<nav class="block">
		<ul>
		<li class="default"><a href="/category/default/">转载</a></li>
		<li class="code"><a href="/category/code/">笔记</a></li>
		
		</ul>
	</nav>
	
	<form action="/search/" class="block block-search">
		<h3>Search</h3>
		<p><input type="search" name="q" placeholder="Search" /></p>
	</form>
	
	<div class="block block-about">
		<h3>About</h3>
		<figure>
			
			<figcaption><strong>HuangDing</strong></figcaption>
		</figure>
		<p>dotnet, mvc, python</p>
	</div>
	
	<div class="block block-license">
		<h3>Copyright</h3>
		<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/cn/" target="_blank" class="hide-target-icon" title="Copyright declaration of site content"><img alt="知识共享许可协议" src="http://i.creativecommons.org/l/by-nc-nd/2.5/cn/88x31.png" /></a></p>
	</div>
	
	
	<div class="block block-fork">
		<a href="https://github.com/beango"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
	</div>
	
	
	<div class="block block-thank">
		<h3>Powered by</h3>
		<p>
			<a href="http://disqus.com/" target="_blank">Disqus</a>,
			<a href="http://elfjs.com/" target="_blank">elf+js</a>,
			<a href="https://github.com/" target="_blank">GitHub</a>,
			<a href="http://www.google.com/cse/" target="_blank">Google Custom Search</a>,
			<a href="http://en.gravatar.com/" target="_blank">Gravatar</a>,
			<a href="http://softwaremaniacs.org/soft/highlight/en/">HighlightJS</a>,
			<a href="https://github.com/mojombo/jekyll" target="_blank">jekyll</a>,
			<a href="https://github.com/mytharcher/SimpleGray" target="_blank">SimpleGray</a>
		</p>
	</div>
</aside>

<script src="http://elfjs.qiniudn.com/code/elf-0.5.0.min.js"></script>
<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

<script src="/assets/js/site.js"></script>

<script>
site.URL_GOOGLE_API = 'http://www.google.com/jsapi';
site.URL_DISCUS_COMMENT = 'beango' ? 'http://beango.disqus.com/embed.js' : '';

site.VAR_SITE_NAME = '程序员 - 博客 - HuangDing';
site.VAR_GOOGLE_CUSTOM_SEARCH_ID = '015845096645085761197:gh2gyye7u1m';
site.TPL_SEARCH_TITLE = '#{0} / 搜索：#{1}';
site.VAR_AUTO_LOAD_ON_SCROLL = 0;
</script>
</body>
</html>