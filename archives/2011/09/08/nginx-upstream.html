<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="author" content="HuangDing" />
<meta name="keywords" content="nginx,linux" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>程序员 - 博客 - HuangDing / nginx upstream 的几种分配方式</title>
<link href="http://http://uwebs.tk/feed.xml" rel="alternate" title="程序员 - 博客 - HuangDing" type="application/atom+xml" />
<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/site.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/code/github.css" />

</head>

<body class="page-type-post">

<div class="main">
	<div class="trace">/ <a href="/">程序员 - 博客 - HuangDing</a> / nginx upstream 的几种分配方式</div>

<article>
	<h1><a href="/archives/2011/09/08/nginx-upstream.html">nginx upstream 的几种分配方式</a></h1>
	
	<p class="meta">
	<span class="datetime">2011-09-08</span> posted in [<a href="/category/default" class="category">转载</a>]
</p>
	
<p>1、轮询（默认）</p>

<p>每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>

<p>2、weight
指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。
例如：</p>

<pre><code>upstream bakend {
  server 192.168.1.10 weight=10;
  server 192.168.1.11 weight=10;
}
</code></pre>

<p>3、ip_hash</p>

<p>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。
例如：</p>

<pre><code>upstream resinserver{
  ip_hash;
  server 192.168.1.10:8080;
  server 192.168.1.11:8080;
}
</code></pre>

<p>4、fair（第三方）
按后端服务器的响应时间来分配请求，响应时间短的优先分配。</p>

<pre><code>upstream resinserver{
  server server1;
  server server2;
  fair;
}
</code></pre>

<p>5、url_hash（第三方）</p>

<p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</p>

<p>例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</p>

<pre><code>upstream resinserver{
  server squid1:3128;
  server squid2:3128;
  hash $request_uri;
  hash_method crc32;
}
</code></pre>

<p>定义负载均衡设备的Ip及设备状态</p>

<pre><code>upstream resinserver{ 
  ip_hash;
  server 127.0.0.1:8000 down;
  server 127.0.0.1:8080 weight=2;
  server 127.0.0.1:6801;
  server 127.0.0.1:6802 backup;
}
</code></pre>

<p>在需要使用负载均衡的server中增加</p>

<pre><code>proxy_pass http://resinserver/;
</code></pre>

<p>每个设备的状态设置为:<br />
1.down 表示单前的server暂时不参与负载<br />
2.weight 默认为1.weight越大，负载的权重就越大。<br />
3.max_fails：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream模块定义的错误<br />
4.fail_timeout:max_fails次失败后，暂停的时间。<br />
5.backup：其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。<br />
nginx支持同时设置多组的负载均衡，用来给不用的server来使用。</p>

<p>client_body_in_file_only 设置为On 可以讲client post过来的数据记录到文件中用来做debug client_body_temp_path 设置记录文件的目录 可以设置最多3层目录location 对URL进行匹配.可以进行重定向或者进行新的代理负载均衡</p>

	
	<!--<p class="permalink">永久链接：<a href="http://http://uwebs.tk/archives/2011/09/08/nginx-upstream.html">http://http://uwebs.tk/archives/2011/09/08/nginx-upstream.html</a></p>-->
</article>
<div id="disqus_thread" class="comments"></div>


	<footer>
		<p>&copy; Since 2012</p>
	</footer>
</div>

<aside>
	<h2><a href="/">程序员 - 博客 - HuangDing</a><a href="/feed.xml" class="feed-link" title="Subscribe"><i class="fa fa-rss-square"></i></a></h2>
	
	<nav class="block">
		<ul>
		<li class="default"><a href="/category/default/">转载</a></li>
		<li class="code"><a href="/category/code/">笔记</a></li>
		
		</ul>
	</nav>
	
	<form action="/search/" class="block block-search">
		<h3>Search</h3>
		<p><input type="search" name="q" placeholder="Search" /></p>
	</form>
	
	<div class="block block-about">
		<h3>About</h3>
		<figure>
			
			<figcaption><strong>HuangDing</strong></figcaption>
		</figure>
		<p>dotnet, mvc, python</p>
	</div>
	
	<div class="block block-license">
		<h3>Copyright</h3>
		<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/cn/" target="_blank" class="hide-target-icon" title="Copyright declaration of site content"><img alt="知识共享许可协议" src="http://i.creativecommons.org/l/by-nc-nd/2.5/cn/88x31.png" /></a></p>
	</div>
	
	
	<div class="block block-fork">
		<a href="https://github.com/beango"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
	</div>
	
	
	<div class="block block-thank">
		<h3>Powered by</h3>
		<p>
			<a href="http://disqus.com/" target="_blank">Disqus</a>,
			<a href="http://elfjs.com/" target="_blank">elf+js</a>,
			<a href="https://github.com/" target="_blank">GitHub</a>,
			<a href="http://www.google.com/cse/" target="_blank">Google Custom Search</a>,
			<a href="http://en.gravatar.com/" target="_blank">Gravatar</a>,
			<a href="http://softwaremaniacs.org/soft/highlight/en/">HighlightJS</a>,
			<a href="https://github.com/mojombo/jekyll" target="_blank">jekyll</a>,
			<a href="https://github.com/mytharcher/SimpleGray" target="_blank">SimpleGray</a>
		</p>
	</div>
</aside>

<script src="http://elfjs.qiniudn.com/code/elf-0.5.0.min.js"></script>
<script src="http://yandex.st/highlightjs/7.3/highlight.min.js"></script>

<script src="/assets/js/site.js"></script>

<script>
site.URL_GOOGLE_API = 'http://www.google.com/jsapi';
site.URL_DISCUS_COMMENT = 'beango' ? 'http://beango.disqus.com/embed.js' : '';

site.VAR_SITE_NAME = '程序员 - 博客 - HuangDing';
site.VAR_GOOGLE_CUSTOM_SEARCH_ID = '015845096645085761197:gh2gyye7u1m';
site.TPL_SEARCH_TITLE = '#{0} / 搜索：#{1}';
site.VAR_AUTO_LOAD_ON_SCROLL = 0;
</script>
</body>
</html>